<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vector Pong Arena</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a2e;
            --panel-bg-color: rgba(22, 33, 62, 0.95);
            --table-color: #16213e;
            --accent-color: #0f3460;
            --highlight-color: #e94560;
            --text-color: #ffffff;
            --glow-color: rgba(233, 69, 96, 0.7);
            --font-family: 'Press Start 2P', cursive;
        }
        body { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: var(--font-family); color: var(--text-color); overflow: hidden; position: relative; background-color: var(--bg-color); transition: background-color 0.5s ease; }
        body.theme-space { background-image: radial-gradient(1px 1px at 20px 30px, #fff, transparent), radial-gradient(1px 1px at 40px 70px, #fff, transparent), radial-gradient(2px 2px at 90px 40px, #fff, transparent), radial-gradient(1px 1px at 130px 180px, #ddd, transparent), radial-gradient(1px 1px at 160px 120px, #ddd, transparent); background-repeat: repeat, repeat; background-size: 250px 250px, 500px 500px; animation: move-close-stars 120s linear infinite, move-far-stars 240s linear infinite; }
        body.theme-space::before, body.theme-space::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-repeat: no-repeat; mix-blend-mode: screen; }
        body.theme-space::before { background-image: radial-gradient(circle at 20% 30%, rgba(233, 69, 96, 0.25), transparent 40%); animation: move-nebula-1 150s ease-in-out infinite alternate; }
        body.theme-space::after { background-image: radial-gradient(circle at 80% 70%, rgba(60, 120, 255, 0.25), transparent 40%); animation: move-nebula-2 180s ease-in-out infinite alternate; }
        body.theme-synthwave { background: linear-gradient(to bottom, #2c003e, #5a1846, #9c2759, #e94560); }
        body.theme-synthwave::before, body.theme-synthwave::after { content: ''; position: absolute; left: 0; width: 100%; z-index: -1; }
        body.theme-synthwave::before { bottom: 0; height: 40vh; background: radial-gradient(circle at 50% 150%, #ffcc00, transparent 40%); animation: sun-glow 5s ease-in-out infinite alternate; }
        body.theme-synthwave::after { bottom: 0; height: 50vh; background: linear-gradient(to top, rgba(0, 255, 255, 0.2) 1px, transparent 1px), linear-gradient(to right, rgba(0, 255, 255, 0.2) 1px, transparent 1px); background-size: 40px 20px; transform: perspective(300px) rotateX(60deg); transform-origin: bottom center; animation: move-grid 8s linear infinite; }
        body.theme-jungle { background-color: #013220; }
        body.theme-jungle::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: linear-gradient(135deg, rgba(57, 255, 20, 0.1) 2px, transparent 2px), linear-gradient(225deg, rgba(57, 255, 20, 0.1) 2px, transparent 2px); background-size: 60px 60px; animation: move-vines 20s linear infinite; }
        body.theme-bloodmoon { background-color: #1a1a1a; }
        body.theme-bloodmoon::before, body.theme-bloodmoon::after { content: ''; position: absolute; left: 0; width: 100%; height: 100%; z-index: -1; }
        body.theme-bloodmoon::before { top: 10%; left: 50%; width: 200px; height: 200px; margin-left: -100px; background-color: #c0392b; border-radius: 50%; box-shadow: 0 0 50px #c0392b, 0 0 100px #e74c3c; }
        body.theme-bloodmoon::after { top: 0; background: linear-gradient(rgba(44, 44, 44, 0.3) 0%, transparent 100%); background-size: 100% 200px; animation: move-clouds 60s linear infinite; }
        body.theme-daylight { background: linear-gradient(to bottom, #87CEEB, #B0E0E6); }
        body.theme-daylight::before, body.theme-daylight::after { content: ''; position: absolute; left: 0; width: 200%; height: 100%; z-index: -1; background-image: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8) 0%, transparent 40%), radial-gradient(circle at 70% 40%, rgba(255,255,255,0.7) 0%, transparent 30%); background-repeat: no-repeat; }
        body.theme-daylight::before { animation: move-clouds-day 80s linear infinite; }
        body.theme-daylight::after { animation: move-clouds-day-2 120s linear infinite; }
        h1 { font-size: 2.5rem; color: var(--highlight-color); text-shadow: 0 0 10px var(--glow-color), 0 0 20px var(--glow-color); margin-bottom: 0; animation: flicker 1.5s infinite alternate; }
        #win-streak-display { font-size: 0.8rem; margin-top: 0.5rem; margin-bottom: 1rem; color: var(--highlight-color); text-shadow: 0 0 5px var(--glow-color); }
        #top-bar { position: absolute; top: 1rem; right: 1rem; }
        #player-names { font-size: 1rem; opacity: 0.8; padding: 0 2rem; width: 800px; max-width: 90vw; display: flex; justify-content: space-between; }
        #score-board { font-size: 2.5rem; margin-bottom: 1rem; width: 800px; max-width: 90vw; display: flex; justify-content: center; gap: 50px; }
        .score-flash { animation: score-pulse 0.5s ease-out; }
        #game-wrapper { position: relative; width: 800px; height: 400px; max-width: 90vw; }
        #game-wrapper.shake { animation: screen-shake 0.15s linear; }
        #gameCanvas { position: absolute; top: 0; left: 0; background-color: transparent; border: 4px solid var(--accent-color); border-radius: 10px; box-shadow: 0 0 30px var(--accent-color); z-index: 5; }
        .goal-flash { position: absolute; top: 0; width: 50%; height: 100%; z-index: 6; pointer-events: none; opacity: 0; }
        #left-goal-flash { left: 0; }
        #right-goal-flash { right: 0; }
        .goal-flash.animate { animation: goal-fade 0.5s ease-out; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 20; transition: opacity 0.3s ease-out, visibility 0.3s; background-color: var(--panel-bg-color); visibility: visible; opacity: 1; }
        .overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .overlay h2 { font-size: 2rem; margin-bottom: 0.5rem; color: var(--highlight-color); animation: pulse 2s infinite; }
        .overlay p { font-size: 1.2rem; margin-bottom: 1.5rem; color: var(--text-color); }
        #start-screen { z-index: 21; cursor: pointer; }
        #countdown-overlay { font-size: 8rem; color: var(--highlight-color); text-shadow: 0 0 20px var(--glow-color); z-index: 15; background-color: transparent; }
        .settings-panel, .shortcuts-panel { display: flex; flex-direction: column; gap: 2rem; padding: 2rem 2.5rem; background-color: var(--bg-color); border: 3px solid var(--accent-color); border-radius: 10px; box-shadow: 0 0 30px var(--glow-color); width: 90%; max-width: 700px; }
        .settings-title { text-align: center; width: 100%; margin: 0 0 1rem 0; }
        .settings-content { display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; width: 100%; }
        .settings-column { display: flex; flex-direction: column; gap: 2.5rem; }
        .settings-column:first-child { border-right: 2px solid var(--accent-color); padding-right: 3rem; }
        .settings-section-title { font-size: 1.1rem; color: var(--highlight-color); margin: 0 0 1rem 0; padding-bottom: 0.8rem; border-bottom: 1px solid var(--accent-color); }
        .settings-group { display: flex; justify-content: space-between; align-items: center; gap: 1rem; font-size: 0.8rem; }
        .selector-group { display: flex; gap: 5px; flex-wrap: wrap; justify-content: flex-end; }
        .shortcuts-panel { max-width: 550px; }
        .shortcuts-list { list-style: none; padding: 0; margin: 0; text-align: left; width: 100%; }
        .shortcuts-list li { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--accent-color); font-size: 0.9rem; }
        .shortcuts-list li:last-child { border-bottom: none; }
        .shortcuts-list span { color: var(--highlight-color); }
        .control-button { padding: 10px 20px; font-family: var(--font-family); font-size: 1rem; color: var(--text-color); background-color: var(--accent-color); border: 2px solid var(--highlight-color); border-radius: 5px; cursor: pointer; transition: all 0.2s ease; }
        .control-button:hover { background-color: var(--highlight-color); box-shadow: 0 0 15px var(--glow-color); }
        .control-button.full-width { width: 100%; }
        .icon-button { font-size: 1.5rem; padding: 5px 10px; }
        .settings-btn { padding: 8px 10px; font-family: var(--font-family); font-size: 0.7rem; color: var(--text-color); background: var(--accent-color); border: 2px solid transparent; cursor: pointer; transition: all 0.3s ease; clip-path: polygon(10% 0%, 100% 0%, 90% 100%, 0% 100%); }
        .settings-btn:hover:not(.selected):not(:disabled) { background: var(--highlight-color); color: var(--bg-color); }
        .settings-btn.selected { background: var(--highlight-color); border-color: var(--text-color); box-shadow: 0 0 10px var(--glow-color); }
        .control-button:disabled, .settings-btn:disabled { cursor: not-allowed; opacity: 0.5; background: #555; border-color: #777; }
        .hidden { opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #theme-selector { gap: 10px; }
        .theme-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.2s ease; }
        .theme-swatch.selected { border-color: var(--highlight-color); transform: scale(1.1); box-shadow: 0 0 10px var(--glow-color); }
        .control-switch-container { display: flex; align-items: center; gap: 10px; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--accent-color); transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--highlight-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        input:disabled + .slider { cursor: not-allowed; opacity: 0.5; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 120px; background: transparent; }
        input[type="range"]::-webkit-slider-runnable-track { height: 8px; background: var(--accent-color); border-radius: 4px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -6px; height: 20px; width: 20px; background: var(--highlight-color); border-radius: 50%; cursor: pointer; border: 2px solid var(--text-color); }
        @keyframes flicker { 0%, 100% { text-shadow: 0 0 10px var(--glow-color), 0 0 20px var(--glow-color); opacity: 1; } 50% { text-shadow: 0 0 10px var(--glow-color), 0 0 25px var(--glow-color); opacity: 0.8; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes score-pulse { 0% { transform: scale(1); color: var(--text-color); } 50% { transform: scale(1.3); color: var(--highlight-color); } 100% { transform: scale(1); color: var(--text-color); } }
        @keyframes screen-shake { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(-3px, 2px); } 50% { transform: translate(2px, -3px); } 75% { transform: translate(3px, 3px); } }
        @keyframes goal-fade { 0% { opacity: 0; background: radial-gradient(circle, var(--highlight-color) 0%, transparent 10%); } 50% { opacity: 0.6; background: radial-gradient(circle, var(--highlight-color) 0%, transparent 60%); } 100% { opacity: 0; background: radial-gradient(circle, var(--highlight-color) 0%, transparent 100%); } }
        @keyframes move-vines { from { background-position: 0 0; } to { background-position: 120px 60px; } }
        @keyframes sun-glow { from { opacity: 0.8; } to { opacity: 1; } }
        @keyframes move-grid { from { background-position: 0 0; } to { background-position: 0 -80px; } }
        @keyframes move-close-stars { from { background-position: 0 0, 0 0; } to { background-position: 250px 250px, 0 0; } }
        @keyframes move-far-stars { from { background-position: 0 0, 0 0; } to { background-position: 0 0, 500px 500px; } }
        @keyframes move-nebula-1 { from { transform: translate(-20%, -15%) scale(1.2); } to { transform: translate(15%, 20%) scale(1.5); } }
        @keyframes move-nebula-2 { from { transform: translate(15%, 10%) scale(1.2); } to { transform: translate(-15%, -20%) scale(1); } }
        @keyframes move-clouds { from { background-position: -400px 0; } to { background-position: 400px 0; } }
        @keyframes move-clouds-day { from { transform: translateX(-100%); } to { transform: translateX(100%); } }
        @keyframes move-clouds-day-2 { from { transform: translateX(100%); } to { transform: translateX(-100%); } }
    </style>
</head>
<body>
    <h1 id="game-title">Vector Pong Arena</h1>
    <div id="win-streak-display">Win Streak: 0</div>
    <div id="top-bar"><button id="settings-button" class="control-button icon-button" aria-label="Settings">‚öôÔ∏è</button></div>
    <div id="player-names"><span id="player1-name">Player 1</span><span id="player2-name">Computer</span></div>
    <div id="score-board"><span id="player1-score">0</span><span>-</span><span id="player2-score">0</span></div>
    <div id="game-wrapper">
        <div id="left-goal-flash" class="goal-flash"></div>
        <div id="right-goal-flash" class="goal-flash"></div>
        <canvas id="gameCanvas"></canvas>
        <div id="countdown-overlay" class="overlay hidden"></div>
        <div id="start-screen" class="overlay">
            <h2>Click to Play</h2>
            <p id="start-prompt">You vs. Computer</p>
        </div>
        <div id="pause-screen" class="overlay hidden">
            <h2>Paused</h2>
            <p>Press ESC or P to Resume</p>
        </div>
        <div id="game-over-screen" class="overlay hidden">
            <h2 id="winner-message"></h2>
            <button id="play-again-button" class="control-button">Play Again (N)</button>
        </div>
    </div>
    <div id="settings-modal" class="overlay hidden">
        <div class="settings-panel">
            <h2 class="settings-title">Settings</h2>
            <div class="settings-content">
                <div class="settings-column">
                    <div class="settings-section">
                        <h3 class="settings-section-title">Gameplay</h3>
                        <div class="settings-group"><label>Game Mode</label><div id="game-mode-selector" class="selector-group"><button class="settings-btn selected" data-mode="1p">1 Player</button><button class="settings-btn" data-mode="2p">2 Player</button></div></div>
                        <div class="settings-group"><label>Difficulty (1P)</label><div id="difficulty-selector" class="selector-group"><button class="settings-btn selected" data-difficulty="easy">Easy</button><button class="settings-btn" data-difficulty="medium">Medium</button><button class="settings-btn" data-difficulty="hard">Hard</button></div></div>
                        <div class="settings-group"><label>P1 Controls</label><div class="control-switch-container"><span>Mouse</span><label class="toggle-switch"><input type="checkbox" id="control-toggle"><span class="slider"></span></label><span>Keyboard</span></div></div>
                    </div>
                    <div class="settings-section"><h3 class="settings-section-title">Visuals</h3><div class="settings-group"><label>Theme</label><div id="theme-selector" class="selector-group"></div></div></div>
                </div>
                <div class="settings-column">
                    <div class="settings-section">
                         <h3 class="settings-section-title">Audio</h3>
                         <div class="settings-group"><label>Master</label><input type="range" id="master-volume" min="0" max="1" step="0.05" value="0.5"></div>
                        <div class="settings-group"><label>Music</label><input type="range" id="music-volume" min="0" max="1" step="0.05" value="0.5"></div>
                        <div class="settings-group"><label>Sound FX</label><input type="range" id="sfx-volume" min="0" max="1" step="0.05" value="0.8"></div>
                    </div>
                    <div class="settings-section">
                         <h3 class="settings-section-title">More</h3>
                         <div class="settings-group"><button id="shortcuts-button" class="control-button full-width">Controls (H)</button></div>
                    </div>
                </div>
            </div>
            <button id="close-settings-button" class="control-button">Close (ESC)</button>
        </div>
    </div>
    <div id="shortcuts-modal" class="overlay hidden">
        <div class="shortcuts-panel">
            <h2>Controls & Shortcuts</h2>
            <ul class="shortcuts-list">
                <li><span>P1 Movement:</span> W / S keys or Mouse</li>
                <li><span>P2 Movement:</span> Up / Down Arrow keys</li>
                <li><span>Pause / Resume:</span> P or ESC</li>
                <li><span>Toggle Settings:</span> S</li>
                <li><span>Toggle This Menu:</span> H</li>
                <li><span>New Game (on game over):</span> N</li>
            </ul>
            <button id="close-shortcuts-button" class="control-button">Close (ESC)</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        class Particle {
            constructor(x, y, color) { this.x = x; this.y = y; this.size = Math.random() * 4 + 1; this.speedX = (Math.random() - 0.5) * 3; this.speedY = (Math.random() - 0.5) * 3; this.color = color; this.life = 1; }
            update() { this.x += this.speedX; this.y += this.speedY; this.life -= 0.04; }
            draw(ctx) { ctx.fillStyle = this.color; ctx.globalAlpha = this.life; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
        }

        class PongGame {
            constructor() {
                this.setupConstants();
                this.selectDOMElements();
                this.init();
            }

            selectDOMElements() {
                const DOMElements = { canvas: 'gameCanvas', gameWrapper: 'game-wrapper', gameTitleElement: 'game-title', winStreakDisplay: 'win-streak-display', player1ScoreDisplay: 'player1-score', player2ScoreDisplay: 'player2-score', player1NameDisplay: 'player1-name', player2NameDisplay: 'player2-name', startScreen: 'start-screen', pauseScreen: 'pause-screen', gameOverScreen: 'game-over-screen', countdownOverlay: 'countdown-overlay', settingsModal: 'settings-modal', shortcutsModal: 'shortcuts-modal', leftGoalFlash: 'left-goal-flash', rightGoalFlash: 'right-goal-flash', settingsButton: 'settings-button', closeSettingsButton: 'close-settings-button', shortcutsButton: 'shortcuts-button', closeShortcutsButton: 'close-shortcuts-button', playAgainButton: 'play-again-button', themeSelector: 'theme-selector', winnerMessage: 'winner-message', startPrompt: 'start-prompt' };
                for (const key in DOMElements) { this[key] = document.getElementById(DOMElements[key]); }
                this.ctx = this.canvas.getContext('2d');
                this.difficultyButtons = document.querySelectorAll('#difficulty-selector .settings-btn');
                this.gameModeButtons = document.querySelectorAll('#game-mode-selector .settings-btn');
                this.controlToggle = document.getElementById('control-toggle');
            }

            setupConstants() {
                this.PADDLE_WIDTH = 12; this.BASE_PADDLE_HEIGHT = 80; this.BALL_RADIUS = 7.5; this.PLAYER_PADDLE_SPEED = 7; this.INITIAL_BALL_SPEED = 5; this.WINNING_SCORE = 11; this.POWERUP_SPAWN_INTERVAL = 10000; this.POWERUP_SIZE = 12;
                this.gameTitles = ['Hyper-Line', 'Astro-Bounce', 'Grid Runner', 'Vector Clash', 'Quantum Paddle', 'Zero-G Rally', 'Starfire Pong', 'Circuit Breaker', 'Nova Pong'];
                this.opponentNames = ['Vector', 'Cipher', 'Blaze', 'Rogue', 'Neon', 'Jolt', 'Apex', 'Pulse', 'Grid', 'Hex', 'Echo', 'Shift'];
                this.themes = [{ name: 'space', className: 'theme-space', particleColors: { trail: 'rgba(233, 69, 96, 0.5)', impact: '#fff' } },{ name: 'synthwave', className: 'theme-synthwave', particleColors: { trail: 'rgba(255, 0, 255, 0.5)', impact: '#00ffff' } },{ name: 'jungle', className: 'theme-jungle', particleColors: { trail: 'rgba(253, 255, 0, 0.5)', impact: '#39FF14' } },{ name: 'bloodmoon', className: 'theme-bloodmoon', particleColors: { trail: 'rgba(236, 240, 241, 0.4)', impact: '#e74c3c' } },{ name: 'daylight', className: 'theme-daylight', particleColors: { trail: 'rgba(255, 255, 255, 0.5)', impact: '#4682B4' } }];
                this.powerUpTypes = { PADDLE_SIZE: { color: '#39FF14', symbol: '‚Üï', duration: 8000 }, OPPONENT_SLOW: { color: '#FDFF00', symbol: 'üêå', duration: 5000 }, SUPER_SPEED: { color: '#ff00ff', symbol: '‚ö°', duration: 6000 } };
            }

            init() {
                this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                this.keysPressed = {}; this.particles = []; this.powerUps = [];
                this.themes.forEach(theme => {
                    const swatch = document.createElement('button');
                    swatch.className = 'theme-swatch'; swatch.dataset.themeName = theme.name;
                    document.body.classList.add(theme.className); // Pre-load theme styles
                    document.body.classList.remove(theme.className);
                    swatch.addEventListener('click', () => { if (!swatch.disabled) { this.playSound('ui'); this.applyTheme(theme); } });
                    this.themeSelector.appendChild(swatch);
                });
                this.gameTitleElement.textContent = this.gameTitles[Math.floor(Math.random() * this.gameTitles.length)];
                this.winStreakDisplay.textContent = `Win Streak: ${localStorage.getItem('pongWinStreak') || 0}`;
                this.resetGame();
                this.bindEventListeners();
                requestAnimationFrame(this.gameLoop.bind(this));
            }

            bindEventListeners() {
                window.addEventListener('resize', this.handleResize.bind(this));
                document.addEventListener('keydown', this.handleKeyDown.bind(this));
                document.addEventListener('keyup', this.handleKeyUp.bind(this));
                this.canvas.addEventListener('mousemove', this.handleMouseMove.bind(this));
                this.startScreen.addEventListener('click', this.startGame.bind(this));
                this.playAgainButton.addEventListener('click', this.resetGame.bind(this));
                this.settingsButton.addEventListener('click', () => this.toggleSettingsModal(true));
                this.closeSettingsButton.addEventListener('click', () => this.toggleSettingsModal(false));
                this.shortcutsButton.addEventListener('click', () => this.toggleShortcutsModal(true));
                this.closeShortcutsButton.addEventListener('click', () => this.toggleShortcutsModal(false));
                this.difficultyButtons.forEach(button => button.addEventListener('click', (e) => this.setDifficulty(e)));
                this.gameModeButtons.forEach(button => button.addEventListener('click', (e) => this.setGameMode(e)));
                this.controlToggle.addEventListener('change', (e) => this.setControlMode(e));
            }

            handleKeyDown(e) { this.keysPressed[e.key] = true; const key = e.key.toLowerCase(); if (key === 'escape') { if (!this.shortcutsModal.classList.contains('hidden')) { this.toggleShortcutsModal(false); return; } if (!this.settingsModal.classList.contains('hidden')) { this.toggleSettingsModal(false); return; } } if (!this.settingsModal.classList.contains('hidden') || !this.shortcutsModal.classList.contains('hidden')) return; if (key === 'p' || key === 'escape') this.togglePause(); if (key === 's') this.toggleSettingsModal(true); if (key === 'h') this.toggleShortcutsModal(true); if (key === 'n' && !this.gameOverScreen.classList.contains('hidden')) this.resetGame(); }
            handleKeyUp(e) { this.keysPressed[e.key] = false; }
            handleMouseMove(e) { if (this.gameState.controlMode !== 'mouse' || !this.gameState.running || this.gameState.paused) return; const rect = this.canvas.getBoundingClientRect(); this.player1.y = e.clientY - rect.top - this.player1.height / 2; }
            handleResize() { this.setCanvasSize(); }
            setDifficulty(e) { if (e.target.disabled) return; this.playSound('ui'); this.difficultyButtons.forEach(btn => btn.classList.remove('selected')); e.target.classList.add('selected'); this.gameState.difficulty = e.target.dataset.difficulty; }
            setGameMode(e) { if(e.target.disabled) return; this.playSound('ui'); this.gameModeButtons.forEach(btn => btn.classList.remove('selected')); e.target.classList.add('selected'); this.gameState.mode = e.target.dataset.mode; this.updateUIForNewGame(); }
            setControlMode(e) { if(e.target.disabled) return; this.playSound('ui'); this.gameState.controlMode = e.target.checked ? 'keyboard' : 'mouse'; }

            playSound(type) { if (!this.audioCtx) return; if (this.audioCtx.state === 'suspended') this.audioCtx.resume(); const o = this.audioCtx.createOscillator(); const g = this.audioCtx.createGain(); o.connect(g); g.connect(this.audioCtx.destination); g.gain.setValueAtTime(0.1, this.audioCtx.currentTime); if (type === 'hit') { o.type = 'square'; o.frequency.setValueAtTime(400, this.audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(300, this.audioCtx.currentTime + 0.1); } else if (type === 'score') { o.type = 'sine'; o.frequency.setValueAtTime(800, this.audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(500, this.audioCtx.currentTime + 0.2); } else if (type === 'wall') { o.type = 'triangle'; o.frequency.setValueAtTime(150, this.audioCtx.currentTime); } else if (type === 'powerup') { o.type = 'sawtooth'; o.frequency.setValueAtTime(900, this.audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(1200, this.audioCtx.currentTime + 0.1); } else if (type === 'ui') { o.type = 'sine'; o.frequency.setValueAtTime(600, this.audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(800, this.audioCtx.currentTime + 0.05); g.gain.exponentialRampToValueAtTime(0.0001, this.audioCtx.currentTime + 0.1); } o.start(this.audioCtx.currentTime); o.stop(this.audioCtx.currentTime + 0.2); }
            
            setDefaultState() {
                this.gameState = { running: false, paused: true, winStreak: parseInt(localStorage.getItem('pongWinStreak')) || 0, mode: '1p', difficulty: 'easy', controlMode: 'mouse', theme: this.themes[0], computerName: this.opponentNames[Math.floor(Math.random() * this.opponentNames.length)], };
                this.player1 = { x: 20, y: 0, score: 0, height: this.BASE_PADDLE_HEIGHT, speedModifier: 1, isHit: false };
                this.player2 = { x: 0, y: 0, score: 0, height: this.BASE_PADDLE_HEIGHT, speedModifier: 1, isHit: false };
                this.ball = { x: 0, y: 0, speedX: 0, speedY: 0, speedModifier: 1 };
                this.particles = []; this.powerUps = [];
            }

            resetGame() {
                if (this.powerUpTimer) clearInterval(this.powerUpTimer);
                this.setDefaultState();
                this.setCanvasSize(); 
                this.player1ScoreDisplay.textContent = '0'; this.player2ScoreDisplay.textContent = '0';
                this.applyTheme(this.themes[Math.floor(Math.random() * this.themes.length)]);
                this.updateUIForNewGame(); this.enableSettings();
                this.startScreen.classList.remove('hidden');
                this.gameOverScreen.classList.add('hidden');
                this.pauseScreen.classList.add('hidden');
            }

            setCanvasSize() {
                this.canvas.width = this.gameWrapper.offsetWidth;
                this.canvas.height = this.gameWrapper.offsetHeight;
                if(this.player1) {
                    this.player1.y = this.canvas.height / 2 - this.player1.height / 2;
                    this.player2.x = this.canvas.width - 20 - this.PADDLE_WIDTH;
                    this.player2.y = this.canvas.height / 2 - this.player2.height / 2;
                    this.ball.x = this.canvas.width / 2;
                    this.ball.y = this.canvas.height / 2;
                }
            }

            startGame() { this.playSound('ui'); this.gameState.running = true; this.disableSettings(); this.startScreen.classList.add('hidden'); this.runCountdown(() => { this.resetBall(); this.powerUpTimer = setInterval(() => this.spawnPowerUp(), this.POWERUP_SPAWN_INTERVAL); }); }
            
            gameLoop() {
                if(this.gameState.running && !this.gameState.paused) { this.update(); }
                this.draw();
                requestAnimationFrame(this.gameLoop.bind(this));
            }

            runCountdown(onComplete) {
                this.gameState.paused = true;
                let countdown = 3;
                this.countdownOverlay.textContent = countdown;
                this.countdownOverlay.classList.remove('hidden');
                this.playSound('ui');
                const countdownInterval = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        this.countdownOverlay.textContent = countdown;
                        this.playSound('ui');
                    } else {
                        clearInterval(countdownInterval);
                        this.countdownOverlay.classList.add('hidden');
                        this.gameState.paused = false;
                        if (onComplete) onComplete();
                    }
                }, 800);
            }

            togglePause() { if (!this.gameState.running) return; if (this.gameState.paused) { this.pauseScreen.classList.add('hidden'); this.runCountdown(); } else { this.gameState.paused = true; this.pauseScreen.classList.remove('hidden'); } }
            
            update() {
                if (this.gameState.controlMode === 'keyboard') {
                    if (this.keysPressed['w'] || this.keysPressed['W']) this.player1.y -= this.PLAYER_PADDLE_SPEED * this.player1.speedModifier;
                    if (this.keysPressed['s'] || this.keysPressed['S']) this.player1.y += this.PLAYER_PADDLE_SPEED * this.player1.speedModifier;
                }
                this.player1.y = Math.max(0, Math.min(this.player1.y, this.canvas.height - this.player1.height));
                if (this.gameState.mode === '2p') {
                    if (this.keysPressed['ArrowUp']) this.player2.y -= this.PLAYER_PADDLE_SPEED * this.player2.speedModifier;
                    if (this.keysPressed['ArrowDown']) this.player2.y += this.PLAYER_PADDLE_SPEED * this.player2.speedModifier;
                } else {
                    const difficultyMultiplier = { easy: 0.6, medium: 0.8, hard: 1.0 };
                    const aiSpeed = this.PLAYER_PADDLE_SPEED * difficultyMultiplier[this.gameState.difficulty] * this.player2.speedModifier;
                    if (this.player2.y + this.player2.height / 2 < this.ball.y - 10) this.player2.y += aiSpeed;
                    else if (this.player2.y + this.player2.height / 2 > this.ball.y + 10) this.player2.y -= aiSpeed;
                }
                this.player2.y = Math.max(0, Math.min(this.player2.y, this.canvas.height - this.player2.height));
                const prevBallX = this.ball.x; this.ball.x += this.ball.speedX * this.ball.speedModifier; this.ball.y += this.ball.speedY * this.ball.speedModifier;
                this.createParticles(this.ball.x, this.ball.y, 1, this.gameState.theme.particleColors.trail);
                if (this.ball.y - this.BALL_RADIUS <= 0 || this.ball.y + this.BALL_RADIUS >= this.canvas.height) { this.ball.speedY *= -1; this.playSound('wall'); }
                if (this.ball.speedX < 0 && this.ball.x - this.BALL_RADIUS < this.player1.x + this.PADDLE_WIDTH && prevBallX - this.BALL_RADIUS >= this.player1.x + this.PADDLE_WIDTH && this.ball.y > this.player1.y && this.ball.y < this.player1.y + this.player1.height) { const impact = (this.ball.y - (this.player1.y + this.player1.height / 2)) / (this.player1.height / 2); this.ball.speedX = Math.abs(this.ball.speedX) * 1.05; this.ball.speedY = impact * this.INITIAL_BALL_SPEED * 1.5; this.handlePaddleHit(this.player1); }
                if (this.ball.speedX > 0 && this.ball.x + this.BALL_RADIUS > this.player2.x && prevBallX + this.BALL_RADIUS <= this.player2.x && this.ball.y > this.player2.y && this.ball.y < this.player2.y + this.player2.height) { const impact = (this.ball.y - (this.player2.y + this.player2.height / 2)) / (this.player2.height / 2); this.ball.speedX = -Math.abs(this.ball.speedX) * 1.05; this.ball.speedY = impact * this.INITIAL_BALL_SPEED * 1.5; this.handlePaddleHit(this.player2); }
                if (this.ball.x < 0) this.handleScore(this.player2, false); if (this.ball.x > this.canvas.width) this.handleScore(this.player1, true);
                for (let i = this.powerUps.length - 1; i >= 0; i--) { const p = this.powerUps[i]; const dx = this.ball.x - p.x; const dy = this.ball.y - p.y; if (Math.sqrt(dx * dx + dy * dy) < this.BALL_RADIUS + this.POWERUP_SIZE) { this.activatePowerUp(p, this.ball.speedX > 0 ? this.player2 : this.player1); this.powerUps.splice(i, 1); } }
                this.particles.forEach((p, i) => { p.update(); if (p.life <= 0) this.particles.splice(i, 1); });
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.fillStyle = this.gameState.theme.name === 'synthwave' ? 'rgba(44, 0, 62, 0.1)' : 'rgba(22, 33, 62, 0.25)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.strokeStyle = 'rgba(15, 52, 96, 0.5)'; this.ctx.lineWidth = 4; this.ctx.setLineDash([10, 10]); this.ctx.beginPath(); this.ctx.moveTo(this.canvas.width / 2, 0); this.ctx.lineTo(this.canvas.width / 2, this.canvas.height); this.ctx.stroke(); this.ctx.setLineDash([]);
                this.particles.forEach(p => p.draw(this.ctx));
                this.ctx.globalAlpha = 1; this.ctx.shadowColor = '#fff'; this.ctx.shadowBlur = 10;
                this.ctx.fillStyle = this.player1.isHit ? 'var(--highlight-color)' : '#fff';
                this.ctx.fillRect(this.player1.x, this.player1.y, this.PADDLE_WIDTH, this.player1.height);
                this.ctx.fillStyle = this.player2.isHit ? 'var(--highlight-color)' : '#fff';
                this.ctx.fillRect(this.player2.x, this.player2.y, this.PADDLE_WIDTH, this.player2.height);
                this.ctx.fillStyle = 'var(--highlight-color)'; this.ctx.shadowColor = 'var(--glow-color)'; this.ctx.shadowBlur = 20;
                this.ctx.beginPath(); this.ctx.arc(this.ball.x, this.ball.y, this.BALL_RADIUS, 0, Math.PI * 2); this.ctx.fill(); this.ctx.shadowBlur = 0;
                this.powerUps.forEach(p => { const typeInfo = this.powerUpTypes[p.type]; this.ctx.fillStyle = typeInfo.color; this.ctx.beginPath(); this.ctx.arc(p.x, p.y, this.POWERUP_SIZE, 0, Math.PI * 2); this.ctx.fill(); this.ctx.fillStyle = '#000'; this.ctx.font = '12px "Press Start 2P"'; this.ctx.textAlign = 'center'; this.ctx.textBaseline = 'middle'; this.ctx.fillText(typeInfo.symbol, p.x, p.y + 1); });
            }

            handlePaddleHit(player) { player.isHit = true; setTimeout(() => player.isHit = false, 150); this.playSound('hit'); this.createParticles(this.ball.x, this.ball.y, 20, this.gameState.theme.particleColors.impact); }
            createParticles(x, y, count, color) { for (let i = 0; i < count; i++) { this.particles.push(new Particle(x, y, color)); } }

            handleScore(scoringPlayer, isPlayer1) {
                this.playSound('score'); scoringPlayer.score++; this.powerUps = [];
                const displayElement = isPlayer1 ? this.player1ScoreDisplay : this.player2ScoreDisplay;
                displayElement.textContent = scoringPlayer.score; displayElement.classList.add('score-flash'); setTimeout(() => displayElement.classList.remove('score-flash'), 500);
                this.gameWrapper.classList.add('shake'); setTimeout(() => this.gameWrapper.classList.remove('shake'), 150);
                const flashElement = isPlayer1 ? this.rightGoalFlash : this.leftGoalFlash;
                flashElement.classList.add('animate'); setTimeout(() => flashElement.classList.remove('animate'), 500);
                if (scoringPlayer.score >= this.WINNING_SCORE) { this.endGame(isPlayer1); }
                else { this.runCountdown(() => { this.resetBall(isPlayer1 ? -1 : 1); }); }
            }
            
            resetBall(serveDirection = 1) {
                this.ball.x = this.canvas.width / 2; this.ball.y = this.canvas.height / 2;
                let angle = Math.random() * Math.PI / 2 - Math.PI / 4;
                this.ball.speedX = this.INITIAL_BALL_SPEED * Math.cos(angle) * serveDirection;
                this.ball.speedY = this.INITIAL_BALL_SPEED * Math.sin(angle);
                this.ball.speedModifier = 1;
            }
            
            endGame(player1Won) {
                this.gameState.running = false; if (this.powerUpTimer) clearInterval(this.powerUpTimer);
                if(player1Won) { this.gameState.winStreak++; } else { this.gameState.winStreak = 0; }
                localStorage.setItem('pongWinStreak', this.gameState.winStreak);
                this.winnerMessage.textContent = player1Won ? "You Win!" : `${this.gameState.mode === '2p' ? 'Player 2' : this.gameState.computerName} Wins!`;
                this.winStreakDisplay.textContent = `Win Streak: ${this.gameState.winStreak}`;
                this.gameOverScreen.classList.remove('hidden');
            }
            
            applyTheme(theme) { this.gameState.theme = theme; document.body.className = theme.className; document.querySelectorAll('.theme-swatch').forEach(swatch => { swatch.classList.toggle('selected', swatch.dataset.themeName === theme.name); }); }
            toggleSettingsModal(show) { this.settingsModal.classList.toggle('hidden', !show); if (show && this.gameState.running && !this.gameState.paused) { this.togglePause(); } }
            toggleShortcutsModal(show) { this.shortcutsModal.classList.toggle('hidden', !show); if (show && this.gameState.running && !this.gameState.paused) { this.togglePause(); } }
            updateUIForNewGame() {
                if (this.gameState.mode === '1p') {
                    this.player1NameDisplay.textContent = 'Player 1'; this.player2NameDisplay.textContent = this.gameState.computerName;
                    this.startPrompt.textContent = `You vs. ${this.gameState.computerName}`; this.difficultyButtons.forEach(b => b.disabled = false);
                } else {
                    this.player1NameDisplay.textContent = 'Player 1'; this.player2NameDisplay.textContent = 'Player 2';
                    this.startPrompt.textContent = 'Player 1 vs. Player 2'; this.difficultyButtons.forEach(b => b.disabled = true);
                }
            }
            enableSettings() { this.settingsModal.querySelectorAll('.settings-btn, .theme-swatch, input').forEach(el => el.disabled = false); this.difficultyButtons.forEach(btn => { btn.classList.toggle('selected', btn.dataset.difficulty === this.gameState.difficulty); }); this.updateUIForNewGame(); }
            disableSettings() { this.settingsModal.querySelectorAll('.settings-btn, .theme-swatch, input').forEach(el => el.disabled = true); }
            
            activatePowerUp(powerUp, hittingPlayer) {
                this.playSound('powerup');
                const typeInfo = this.powerUpTypes[powerUp.type];
                switch (powerUp.type) {
                    case 'PADDLE_SIZE': hittingPlayer.height = this.BASE_PADDLE_HEIGHT * 1.5; setTimeout(() => { hittingPlayer.height = this.BASE_PADDLE_HEIGHT; }, typeInfo.duration); break;
                    case 'OPPONENT_SLOW': const opponent = (hittingPlayer === this.player1) ? this.player2 : this.player1; opponent.speedModifier = 0.5; setTimeout(() => { opponent.speedModifier = 1; }, typeInfo.duration); break;
                    case 'SUPER_SPEED': this.ball.speedModifier = 1.6; setTimeout(() => { this.ball.speedModifier = 1; }, typeInfo.duration); break;
                }
            }
        }

        new PongGame();
    });
    </script>
</body>
</html>
